{% extends 'base.html' %}
{% block title %}Inicio - Empresas en Venta{% endblock %}
{% block content %}
<h1 class="mb-4 text-center text-primary">Empresas en Venta</h1>

<!-- Filtros -->
<form method="GET" action="{{ url_for('index') }}" class="mb-4">
    <div class="card p-3 shadow-sm mb-4">
        <div class="row g-3 align-items-end">

            <!-- Actividad -->
            <div class="col-md-4">
                <label for="actividad" class="form-label">Actividad</label>
                <select class="form-select" id="actividad" name="actividad">
                    <option value="">Todas las actividades</option>
                    {% for act in actividades %}
                        <option value="{{ act }}" {% if request.args.get('actividad') == act %}selected{% endif %}>{{ act }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Sector -->
            <div class="col-md-4">
                <label for="sector" class="form-label">Sector</label>
                <select class="form-select" id="sector" name="sector">
                    <option value="">Todos los sectores</option>
                    {% for sec in sectores %}
                        <option value="{{ sec }}" {% if request.args.get('sector') == sec %}selected{% endif %}>{{ sec }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- País -->
            <div class="col-md-2">
                <label for="pais" class="form-label">País</label>
                <select class="form-select" id="pais" name="pais" disabled>
                    <option value="España" selected>España</option>
                </select>
            </div>

            <!-- Ubicación -->
            <div class="col-md-2">
                <label for="provincia" class="form-label">Ubicación</label>
                <select class="form-select" id="provincia" name="provincia">
                    <option value="">Todas</option>
                    {% for provincia in ['Madrid','Barcelona','Valencia','Sevilla','Málaga','Zaragoza','Alicante','Murcia'] %}
                        <option value="{{ provincia }}" {% if request.args.get('provincia') == provincia %}selected{% endif %}>{{ provincia }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Rango Facturación -->
            <div class="col-md-2">
                <label for="min_facturacion" class="form-label">Facturación mínima (€)</label>
                <input type="number" class="form-control" id="min_facturacion" name="min_facturacion" value="{{ request.args.get('min_facturacion', '') }}">
            </div>
            <div class="col-md-2">
                <label for="max_facturacion" class="form-label">Facturación máxima (€)</label>
                <input type="number" class="form-control" id="max_facturacion" name="max_facturacion" value="{{ request.args.get('max_facturacion', '') }}">
            </div>

            <!-- Precio con barra deslizable -->
            <div class="col-md-4">
                <label for="precio_venta" class="form-label">Precio máximo (€): <span id="precioValor">{{ request.args.get('max_precio', '1000000') }}</span></label>
                <input type="range" class="form-range" name="max_precio" id="precio_venta" min="10000" max="5000000" step="10000"
                       value="{{ request.args.get('max_precio', 1000000) }}"
                       oninput="document.getElementById('precioValor').innerText = this.value">
            </div>

            <div class="col-md-2 d-grid">
                <button type="submit" class="btn btn-primary mt-3">
                    <i class="bi bi-filter-circle me-1"></i> Filtrar
                </button>
            </div>
        </div>
    </div>
</form>

<!-- Resultados -->
{% if empresas %}
<div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
    {% for e in empresas %}
        <div class="col">
            <div class="card h-100 shadow-sm border-0 rounded-lg overflow-hidden">
                {% if e['imagen_url'] %}
                    <img src="{{ url_for('static', filename='uploads/' + e['imagen_url']) }}" class="card-img-top img-fluid" alt="Imagen de {{ e['nombre'] }}" style="height: 200px; object-fit: cover;">
                {% endif %}
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title text-primary fw-bold">{{ e['nombre'] }}</h5>
                    <p class="card-text text-muted small mb-2">{{ e['descripcion'] }}</p>
                    <ul class="list-unstyled text-muted small mt-auto">
                        <li><i class="bi bi-geo-alt-fill text-info me-2"></i><strong>Ubicación:</strong> {{ e['provincia'] }}</li>
                        <li><i class="bi bi-briefcase-fill text-success me-2"></i><strong>Actividad:</strong> {{ e['actividad']|lower }}</li>
                        <li><i class="bi bi-tags-fill text-secondary me-2"></i><strong>Sector:</strong> {{ e['sector']|lower }}</li>
                        <li><i class="bi bi-currency-euro text-warning me-2"></i><strong>Facturación:</strong> 
                            {% if e['facturacion'] %}{{ "{:,.0f} €".format(e['facturacion']) }}{% else %}No disponible{% endif %}
                        </li>
                        <li><i class="bi bi-cash-coin text-danger me-2"></i><strong>Precio:</strong> 
                            {% if e['precio_venta'] %}{{ "{:,.0f} €".format(e['precio_venta']) }}{% else %}No disponible{% endif %}
                        </li>
                    </ul>
                    <a href="{{ url_for('detalle', id=e['id']) }}" class="btn btn-primary mt-3 w-100 py-2">
                        <i class="bi bi-eye-fill me-2"></i> Ver Detalle
                    </a>
                </div>
            </div>
        </div>
    {% endfor %}
</div>
{% else %}
<div class="alert alert-warning text-center" role="alert">
    No se encontraron empresas disponibles.
</div>
{% endif %}

<!-- Script para actualizar sectores según actividad -->
<script>
    const actividadesSectores = {{ actividades_dict | tojson | safe }};
    const actividadSelect = document.getElementById('actividad');
    const sectorSelect = document.getElementById('sector');
    const sectorActual = "{{ request.args.get('sector', '') }}";

    function actualizarSectores(actividad) {
        const sectores = actividadesSectores[actividad] || [];
        sectorSelect.innerHTML = '<option value="">Todos los sectores</option>';
        sectores.forEach(sec => {
            const option = document.createElement('option');
            option.value = sec;
            option.textContent = sec;
            if (sec === sectorActual) option.selected = true;
            sectorSelect.appendChild(option);
        });
    }

    actividadSelect.addEventListener('change', function () {
        actualizarSectores(this.value);
    });

    // Llamada inicial por si ya hay una actividad seleccionada
    if (actividadSelect.value) {
        actualizarSectores(actividadSelect.value);
    }
</script>
{% endblock %}
