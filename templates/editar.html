{% extends 'base.html' %}
{% block title %}Editar Anuncio{% endblock %}
{% block content %}

<h1 class="mb-4 text-center text-primary">Editar Anuncio de {{ empresa.nombre }}</h1>
<div class="card p-4 shadow-sm mx-auto" style="max-width: 700px;">
Â  Â  <form method="POST" enctype="multipart/form-data" id="editForm"> {# AÃ±adido ID al formulario principal #}
Â  Â  Â  Â  <input type="hidden" id="delete_confirmation_input" name="eliminar" value="false"> {# Campo oculto para la confirmaciÃ³n de eliminaciÃ³n #}
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div class="mb-3">
Â  Â  Â  Â  Â  Â  <label class="form-label">Nombre de la empresa:</label>
Â  Â  Â  Â  Â  Â  <input type="text" class="form-control" name="nombre" value="{{ empresa.nombre or '' }}" required>
Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div class="mb-3">
Â  Â  Â  Â  Â  Â  <label class="form-label">Email de contacto:</label>
Â  Â  Â  Â  Â  Â  <input type="email" class="form-control" name="email_contacto" value="{{ empresa.email_contacto or '' }}" required>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="mb-3">
Â  Â  Â  Â  Â  Â  <label for="telefono" class="form-label">TelÃ©fono de contacto:</label>
Â  Â  Â  Â  Â  Â  <inputÂ 
Â  Â  Â  Â  Â  Â  Â  Â  type="tel"Â 
Â  Â  Â  Â  Â  Â  Â  Â  class="form-control"Â 
Â  Â  Â  Â  Â  Â  Â  Â  id="telefono"Â 
Â  Â  Â  Â  Â  Â  Â  Â  name="telefono"Â 
Â  Â  Â  Â  Â  Â  Â  Â  pattern="[0-9]{9}"Â 
Â  Â  Â  Â  Â  Â  Â  Â  placeholder="Ej: 612345678"Â 
Â  Â  Â  Â  Â  Â  Â  Â  title="Introduce un nÃºmero de telÃ©fono de 9 dÃ­gitos (solo nÃºmeros)"Â 
Â  Â  Â  Â  Â  Â  Â  Â  value="{{ empresa.telefono or '' }}"Â 
Â  Â  Â  Â  Â  Â  Â  Â  required
Â  Â  Â  Â  Â  Â  >
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  Â  <div class="col-md-6 mb-3">
Â  Â  Â  Â  Â  Â  Â  Â  <label class="form-label">Actividad:</label>
Â  Â  Â  Â  Â  Â  Â  Â  <select class="form-select" name="actividad" required id="actividad">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="">-- Selecciona una actividad --</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {% for act in actividades %}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="{{ act }}" {% if empresa.actividad == act %}selected{% endif %}>{{ act }}</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {% endfor %}
Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="col-md-6 mb-3">
Â  Â  Â  Â  Â  Â  Â  Â  <label class="form-label">Sector:</label>
Â  Â  Â  Â  Â  Â  Â  Â  <select class="form-select" name="sector" required id="sector">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="">-- Selecciona un sector --</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {# Los sectores se cargarÃ¡n dinÃ¡micamente mediante JavaScript #}
Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  Â  <div class="col-md-6 mb-3">
Â  Â  Â  Â  Â  Â  Â  Â  <label class="form-label">PaÃ­s:</label>
Â  Â  Â  Â  Â  Â  Â  Â  <select class="form-select" name="pais" required>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="EspaÃ±a" {% if empresa.pais == 'EspaÃ±a' %}selected{% endif %}>EspaÃ±a</option>
Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="col-md-6 mb-3">
Â  Â  Â  Â  Â  Â  Â  Â  <label for="ubicacion" class="form-label">UbicaciÃ³n (Provincia):</label>
Â  Â  Â  Â  Â  Â  Â  Â  <select class="form-select" id="ubicacion" name="ubicacion" required>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="">-- Selecciona una provincia --</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {% for prov in provincias %}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="{{ prov }}" {% if empresa.ubicacion == prov %}selected{% endif %}>{{ prov }}</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {% endfor %}
Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  {# Nuevo campo: Tipo de Negocio #}
Â  Â  Â  Â  <div class="mb-3">
Â  Â  Â  Â  Â  Â  <label for="tipo_negocio" class="form-label">Tipo de Negocio:</label>
Â  Â  Â  Â  Â  Â  <input type="text" class="form-control" id="tipo_negocio" name="tipo_negocio" value="{{ empresa.tipo_negocio or '' }}" required>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="mb-3">
Â  Â  Â  Â  Â  Â  <label class="form-label">DescripciÃ³n:</label>
Â  Â  Â  Â  Â  Â  <textarea class="form-control" name="descripcion" rows="5" required>{{ empresa.descripcion or '' }}</textarea>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  Â  <div class="col-md-6 mb-3">
Â  Â  Â  Â  Â  Â  Â  Â  <label class="form-label">FacturaciÃ³n anual (â‚¬):</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" class="form-control" name="facturacion" step="0.01" min="0" value="{{ empresa.facturacion or '' }}" required>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="col-md-6 mb-3">
Â  Â  Â  Â  Â  Â  Â  Â  <label class="form-label">NÂº empleados:</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" class="form-control" name="numero_empleados" min="0" value="{{ empresa.numero_empleados or '' }}" required>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  Â  <div class="col-md-6 mb-3">
Â  Â  Â  Â  Â  Â  Â  Â  <label class="form-label">Local en propiedad:</label>
Â  Â  Â  Â  Â  Â  Â  Â  <select class="form-select" name="local_propiedad">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Si" {% if empresa.local_propiedad == 'Si' %}selected{% endif %}>SÃ­</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="No" {% if empresa.local_propiedad == 'No' %}selected{% endif %}>No</option>
Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="col-md-6 mb-3">
Â  Â  Â  Â  Â  Â  Â  Â  <label class="form-label">Resultado antes de impuestos (â‚¬):</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" class="form-control" name="resultado_antes_impuestos" step="0.01" value="{{ empresa.resultado_antes_impuestos or '' }}" required>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  Â  <div class="col-md-6 mb-3">
Â  Â  Â  Â  Â  Â  Â  Â  <label class="form-label">Deuda actual (â‚¬):</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" class="form-control" name="deuda" step="0.01" min="0" value="{{ empresa.deuda or '' }}" required>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="col-md-6 mb-3">
Â  Â  Â  Â  Â  Â  Â  Â  <label class="form-label">Precio de venta (â‚¬):</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" class="form-control" name="precio_venta" step="0.01" min="0" value="{{ empresa.precio_venta or '' }}" required>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="mb-3">
Â  Â  Â  Â  Â  Â  <label for="imagen" class="form-label">Actualizar imagen (opcional):</label>
Â  Â  Â  Â  Â  Â  <input type="file" class="form-control" id="imagen" name="imagen" accept="image/*">
Â  Â  Â  Â  Â  Â  {% if empresa.imagen_url %}
Â  Â  Â  Â  Â  Â  Â  Â  <small class="text-muted mt-2 d-block">Imagen actual:</small>
Â  Â  Â  Â  Â  Â  Â  Â  <img src="{{ empresa.imagen_url }}" alt="Imagen actual del negocio" class="img-fluid rounded mt-2" style="max-width: 200px; height: auto;">
Â  Â  Â  Â  Â  Â  {% else %}
Â  Â  Â  Â  Â  Â  Â  Â  <small class="text-muted mt-2 d-block">No hay imagen actual subida.</small>
Â  Â  Â  Â  Â  Â  {% endif %}
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="d-grid gap-2 mt-4">
Â  Â  Â  Â  Â  Â  <button type="submit" class="btn btn-success btn-lg"><i class="bi bi-save-fill me-2"></i>Guardar Cambios</button>
Â  Â  Â  Â  Â  Â  <button type="button" class="btn btn-danger btn-lg mt-2" data-bs-toggle="modal" data-bs-target="#confirmDeleteModal">
Â  Â  Â  Â  Â  Â  Â  Â  <i class="bi bi-trash-fill me-2"></i>Eliminar Anuncio
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  </div>
Â  Â  </form>
</div>

<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
Â  Â  <div class="modal-dialog">
Â  Â  Â  Â  <div class="modal-content">
Â  Â  Â  Â  Â  Â  <div class="modal-header">
Â  Â  Â  Â  Â  Â  Â  Â  <h5 class="modal-title" id="confirmDeleteModalLabel">Confirmar EliminaciÃ³n</h5>
Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="modal-body">
Â  Â  Â  Â  Â  Â  Â  Â  Â¿EstÃ¡s seguro de que quieres eliminar este anuncio? Esta acciÃ³n es irreversible.
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="modal-footer">
Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" class="btn btn-danger" id="confirmDeleteBtnModal">Eliminar Ahora</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>
</div>

<script>
Â  Â  // AsegÃºrate de que 'actividades_dict' del contexto de Flask se pase correctamente
Â  Â  const actividadesSectores = {{ actividades_dict | tojson | safe }};
Â  Â  const actividadSelect = document.getElementById('actividad');
Â  Â  const sectorSelect = document.getElementById('sector');

Â  Â  // ðŸ”‘ CLAVE 1: Captura el sector guardado de la empresa
Â  Â  const initialSector = "{{ empresa.sector or '' }}";

Â  Â  function actualizarSectores(actividad) {
Â  Â  Â  Â  if (!actividad || actividad === "") {
Â  Â  Â  Â  Â  Â  sectorSelect.innerHTML = '<option value="">Seleccione primero la actividad</option>';
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  const sectores = actividadesSectores[actividad] || [];
Â  Â  Â  Â  sectorSelect.innerHTML = '<option value="">-- Selecciona un sector --</option>';
Â  Â  Â  Â  sectores.forEach(sec => {
Â  Â  Â  Â  Â  Â  const option = document.createElement('option');
Â  Â  Â  Â  Â  Â  option.value = sec;
Â  Â  Â  Â  Â  Â  option.textContent = sec;
Â  Â  Â  Â  Â  Â  sectorSelect.appendChild(option);
Â  Â  Â  Â  });

Â  Â  Â  Â  // ðŸ”‘ CLAVE 2: DespuÃ©s de llenar el dropdown, intenta seleccionar el valor guardado
Â  Â  Â  Â  if (initialSector && sectores.includes(initialSector)) {
Â  Â  Â  Â  Â  Â  sectorSelect.value = initialSector;
Â  Â  Â  Â  }
Â  Â  }

Â  Â  actividadSelect.addEventListener('change', function () {
Â  Â  Â  Â  actualizarSectores(this.value);
Â  Â  });

Â  Â  // ðŸ”‘ CLAVE 3: Asegura que la funciÃ³n se ejecuta al cargar la pÃ¡gina para rellenar y seleccionar el sector
Â  Â  window.addEventListener('DOMContentLoaded', function () {
Â  Â  Â  Â  actualizarSectores(actividadSelect.value);
Â  Â  });

Â  Â  // Script para manejar el modal de eliminaciÃ³n - SIMPLIFICADO para una Ãºnica pÃ¡gina de ediciÃ³n
Â  Â  document.addEventListener('DOMContentLoaded', function() {
Â  Â  Â  Â  const confirmDeleteBtnModal = document.getElementById('confirmDeleteBtnModal');
Â  Â  Â  Â  const deleteConfirmationInput = document.getElementById('delete_confirmation_input');
Â  Â  Â  Â  const editForm = document.getElementById('editForm'); // Referencia al formulario principal

Â  Â  Â  Â  if (confirmDeleteBtnModal && deleteConfirmationInput && editForm) {
Â  Â  Â  Â  Â  Â  confirmDeleteBtnModal.addEventListener('click', function() {
Â  Â  Â  Â  Â  Â  Â  Â  // Establece el valor del campo oculto a 'true' para indicar eliminaciÃ³n
Â  Â  Â  Â  Â  Â  Â  Â  deleteConfirmationInput.value = 'true';
Â  Â  Â  Â  Â  Â  Â  Â  // EnvÃ­a el formulario principal
Â  Â  Â  Â  Â  Â  Â  Â  editForm.submit();
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  });
</script>

{% endblock %}
